name: Build & Deploy on AWS
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  
  workflow_dispatch:
    inputs:
      force_rebuild:
        description: "Force rebuild all services"
        required: false
        default: "false"

jobs:
  # Detect which services have changed
  detect-changes:
    runs-on: ubuntu-latest
    environment: production

    outputs:
      backend-matrix: ${{ steps.set-matrix.outputs.backend-matrix }}
      frontend-matrix: ${{ steps.set-matrix.outputs.frontend-matrix }}
      has-backend-change: ${{ steps.set-matrix.outputs.has-backend-change }}
      has-frontend-change: ${{ steps.set-matrix.outputs.has-frontend-change }}
      changed-backend: ${{ steps.set-matrix.outputs.changed-backend }}
      changed-frontend: ${{ steps.set-matrix.outputs.changed-frontend }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v41
        with:
          files_yaml: |
            admin_service:
              - apps/admin-service/**
              - packages/backend/**
            auth_service:
              - apps/auth-service/**
              - packages/backend/**
            product_service:
              - apps/product-service/**
              - packages/backend/**
            api_gateway:
              - apps/api_gateway/**
              - packages/backend/**
            manager_service:
              - apps/manager-service/**
              - packages/backend/**

      - name: Set matrix for changed services
        id: set-matrix
        run: |
          BACKEND_SERVICE=()
          FRONTEND_SERVICE=()

          if [[ "${{ github.event.inputs.force_rebuild }}" == "true" ]]; then
            echo "Force rebuild required - building all services"
            BACKEND_SERVICE=("auth-service" "product-service" "manager-service" "admin-service" "api-gateway")
            FRONTEND_SERVICE=("user-ui" "manager-ui" "vendor-ui" "admin-ui")
          fi