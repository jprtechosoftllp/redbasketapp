name: CI/CD Pipeline for Nx Monorepo (All on Vercel)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  # üß™ 1. Test and Lint
  test:
    name: Test & Lint
    runs-on: ubuntu-latest

    # services:
    #   postgres:
    #     image: postgres:15
    #     env:
    #       POSTGRES_USER: test_user
    #       POSTGRES_PASSWORD: test_password
    #       POSTGRES_DB: meato_test
    #     ports:
    #       - 5432:5432
    #     options: >-
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
          run_install: true
      
      - name: Verify pnpm workspace
        run: |
          echo "üß© Workspace packages:"
          pnpm ls --depth -1

      # - name: Run Linter
      #   run: pnpm nx run-many --target=lint --all || echo "Lint skipped"

      # - name: Run Tests
      #   run: pnpm nx run-many --target=test --all || echo "Tests skipped"
      #   env:
      #     DATABASE_URL: postgresql://test_user:test_password@localhost:5432/meato_test
      #     NODE_ENV: test

  # üèóÔ∏è 2. Build all Nx projects
  build:
    name: Build All Projects
    runs-on: ubuntu-latest
    environment: production  # GitHub environment (for secrets & deploy rules)
    env:
      NODE_VERSION: '22.x'
      PNPM_HOME: ${{ github.workspace }}/.pnpm
      NODE_ENV: production
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: ubuntu update
        run: sudo apt-get update

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
          run_install: true
      
      - name: Verify pnpm workspace
        run: |
          echo "üß© Workspace packages:"
          pnpm ls --depth -1
        
      - name: Build All Apps & Services
        run: pnpm nx run-many --target=build --all --parallel
        env:
          NODE_ENV: production

      - name: Upload compressed build of apps artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-of-apps
          path: apps/
          if-no-files-found: warn
          compression-level: 6
          overwrite: false

  # üöÄ 3. Deploy All Apps & Services to Vercel
  deploy:
    name: Deploy All to Vercel
    runs-on: ubuntu-latest
    environment: production
    needs: build
    if: github.ref == 'refs/heads/main'

    steps:

      - name: ubuntu update
        run: sudo apt-get update

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - uses: pnpm/action-setup@v4
        with:
          version: 10.18.3
          run_install: true

      - name: Install Vercel CLI (pnpm)
        run: pnpm add -g vercel

      # Download artifacts if you built separately
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-of-apps
          # run-id: ${{ github.event.workflow_run.id}}
          # github-token: ${{ github.token }}

      - name: Print working directory
        run: pwd && ls -la
        
      - name: List repo structure
        run: ls -R

      # --- Deploy each app to its own Vercel project ---
      - name: Deploy Admin UI to Vercel
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-admin-ui --cwd=admin-ui
        
      - name: Deploy Manager UI
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-manager-ui --cwd=manager-ui

      - name: Deploy Vendor UI
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-vendor-ui --cwd=vendor-ui

      - name: Deploy User UI
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-user-ui --cwd=user-ui


      # --- Deploy backend services as serverless functions ---
      - name: Deploy Admin Serivce
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-admin-service --cwd=admin-service
      
      - name: Deploy Api-Gateway Serivce
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-api-gateway --cwd=api-gateway
      
      - name: Deploy Product Serivce
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-product-service --cwd=product-service

      - name: Deploy Auth Serivce
        run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }} --name=meato-auth-service --cwd=auth-service

      # - name: Deploy Manager UI
      #   working-directory: manager-ui/   # this changes the current directory for the step
      #   run: vercel --prod --yes --token=${{ secrets.VERCEL_TOKEN }}
      #   env:
      #     VERCEL_PROJECT_ID: ${{ secrets.MANAGER_UI_PROJECT_ID }}
      #     VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}